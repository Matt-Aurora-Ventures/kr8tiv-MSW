---
phase: 03-bidirectional-communication
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/knowledge/git-manager.ts
  - src/knowledge/traceability.ts
autonomous: true

must_haves:
  truths:
    - "GitManager commits research artifacts to .msw/research/ with structured messages"
    - "GitManager gracefully handles non-git directories (warn + skip)"
    - "Traceability links research session IDs to commit references"
  artifacts:
    - path: "src/knowledge/git-manager.ts"
      provides: "Git persistence for research (KNOW-02)"
      exports: ["GitManager"]
    - path: "src/knowledge/traceability.ts"
      provides: "Decision traceability (KNOW-04)"
      exports: ["TraceabilityLinker"]
  key_links:
    - from: "src/knowledge/git-manager.ts"
      to: "simple-git"
      via: "simpleGit() for add/commit"
      pattern: "simpleGit|SimpleGit"
---

<objective>
Build the git persistence layer that commits research artifacts and links code changes to research findings.

Purpose: All Q&A knowledge must be version-controlled and traceable. GitManager handles the mechanical git operations; TraceabilityLinker maintains the mapping between research sessions and code.
Output: Git commit capability for .msw/research/ and session-to-commit traceability.
</objective>

<execution_context>
@C:\Users\lucid\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\lucid\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bidirectional-communication/03-RESEARCH.md
@src/types/bidirectional.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GitManager</name>
  <files>src/knowledge/git-manager.ts</files>
  <action>
Install simple-git: `npm install simple-git`

Create `src/knowledge/git-manager.ts`:

- Import simpleGit, SimpleGit from 'simple-git'
- Import fs (existsSync, mkdirSync) and path (join)
- `GitManager` class:
  - Constructor takes `projectRoot: string`
  - Creates `SimpleGit` instance pointing at projectRoot
  - `researchDir` = `join(projectRoot, '.msw', 'research')`

  Methods:
  - `isGitRepo(): Promise<boolean>` -- try revparse('--is-inside-work-tree'), catch returns false
  - `ensureResearchDir(): Promise<void>` -- mkdirSync with recursive: true if not exists
  - `commitResearch(files: string[], sessionId: string): Promise<string | null>`:
    - Check isGitRepo() first. If not, log warning and return null.
    - `git.add(files)`
    - `git.commit()` with message: `research(msw): session ${sessionId}\n\nAuto-committed by MSW Protocol`
    - Return commit hash
  - `getResearchDir(): string` -- getter for researchDir path
  - `hasUncommittedResearch(): Promise<boolean>` -- check git status for .msw/research/ changes

Handle all git errors gracefully -- log and return null/false, never throw.
  </action>
  <verify>npx tsc --noEmit src/knowledge/git-manager.ts</verify>
  <done>GitManager commits to .msw/research/ and handles non-git repos gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Implement TraceabilityLinker</name>
  <files>src/knowledge/traceability.ts</files>
  <action>
Create `src/knowledge/traceability.ts`:

- `TraceabilityLinker` class:
  - Internal map: `sessionToCommits: Map<string, string[]>` (sessionId -> commit hashes)
  - Internal map: `commitToSession: Map<string, string>` (commit hash -> sessionId)

  Methods:
  - `linkCommit(sessionId: string, commitHash: string): void` -- records bidirectional mapping
  - `getCommitsForSession(sessionId: string): string[]` -- returns commit hashes
  - `getSessionForCommit(commitHash: string): string | undefined`
  - `generateTraceabilityComment(sessionId: string): string`:
    - Returns a string suitable for inclusion in commit messages or code comments
    - Format: `MSW Research: session-{sessionId} ({N} commits)`
  - `toJSON(): Record<string, string[]>` -- serializable form of session->commits map
  - `fromJSON(data: Record<string, string[]>): void` -- restore from serialized form

This is session-level traceability (per research recommendation). Finer granularity deferred to Phase 6.
  </action>
  <verify>npx tsc --noEmit src/knowledge/traceability.ts</verify>
  <done>TraceabilityLinker maintains bidirectional session-to-commit mappings</done>
</task>

</tasks>

<verification>
- Both files type-check clean
- GitManager handles non-git case without throwing
- TraceabilityLinker serializes/deserializes correctly
</verification>

<success_criteria>
- Research artifacts commit to .msw/research/ with descriptive messages
- Non-git directories produce warnings, not crashes
- Session-to-commit traceability is bidirectional and serializable
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-communication/03-05-SUMMARY.md`
</output>
