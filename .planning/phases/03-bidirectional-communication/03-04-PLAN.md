---
phase: 03-bidirectional-communication
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/bidirectional/context-injector.ts
  - src/knowledge/report-compiler.ts
  - src/knowledge/metadata.ts
autonomous: true

must_haves:
  truths:
    - "Context injector formats NotebookLM answers as self-contained markdown for coding agents"
    - "Report compiler converts Q&A pairs to structured markdown with YAML frontmatter"
    - "Metadata tracks source notebook, timestamps, and relevance scores"
  artifacts:
    - path: "src/bidirectional/context-injector.ts"
      provides: "Agent context formatting (BIDR-07)"
      exports: ["ContextInjector", "formatForAgent"]
    - path: "src/knowledge/report-compiler.ts"
      provides: "Q&A to markdown compilation (KNOW-01)"
      exports: ["ReportCompiler", "compileReport"]
    - path: "src/knowledge/metadata.ts"
      provides: "Research metadata tracking (KNOW-03)"
      exports: ["MetadataTracker"]
  key_links:
    - from: "src/bidirectional/context-injector.ts"
      to: "src/bidirectional/answer-chain.ts"
      via: "Reads chain summary for agent context"
      pattern: "AnswerChain|getForContextInjection"
    - from: "src/knowledge/report-compiler.ts"
      to: "gray-matter"
      via: "YAML frontmatter generation"
      pattern: "gray-matter|matter\\.stringify"
---

<objective>
Build the context injection (answers back to agent) and knowledge compilation (Q&A to markdown with metadata). These consume all Wave 1 outputs.

Purpose: Context injector closes the bidirectional loop (BIDR-07). Report compiler and metadata begin the knowledge persistence layer (KNOW-01, KNOW-03).
Output: Formatted agent context, compiled markdown reports with frontmatter metadata.
</objective>

<execution_context>
@C:\Users\lucid\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\lucid\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bidirectional-communication/03-RESEARCH.md
@.planning/phases/03-bidirectional-communication/03-01-SUMMARY.md
@.planning/phases/03-bidirectional-communication/03-03-SUMMARY.md
@src/types/bidirectional.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ContextInjector</name>
  <files>src/bidirectional/context-injector.ts</files>
  <action>
Create `src/bidirectional/context-injector.ts`:

- Import AgentContext from types
- `formatForAgent(ctx: AgentContext): string` (exported standalone):
  - Returns self-contained markdown block:
    ```
    ## NotebookLM Research Finding

    **Query:** {ctx.query}
    **Confidence:** {ctx.confidence} (grounded in uploaded documentation)
    **Sources:** {ctx.citations.join(', ')} (if any)

    {ctx.answer}

    ---
    *Retrieved via MSW Protocol from NotebookLM*
    ```
  - If no citations, omit Sources line

- `ContextInjector` class:
  - `formatSingle(ctx: AgentContext): string` -- delegates to formatForAgent
  - `formatChainSummary(summary: string, latest?: AgentContext): string`:
    - Combines chain summary with latest finding
    - Format: summary block + separator + latest finding (if present)
  - `writeToFile(content: string, outputPath: string): Promise<void>`:
    - Writes formatted context to `.msw/context/latest.md`
    - Creates directory if needed
    - This is the Phase 3 delivery mechanism (Phase 4 MCP will replace with tool responses)
  </action>
  <verify>npx tsc --noEmit src/bidirectional/context-injector.ts</verify>
  <done>ContextInjector formats answers for agent consumption and writes to well-known file path</done>
</task>

<task type="auto">
  <name>Task 2: Implement ReportCompiler and MetadataTracker</name>
  <files>src/knowledge/report-compiler.ts, src/knowledge/metadata.ts</files>
  <action>
Install gray-matter: `npm install gray-matter`

**ReportCompiler** (`src/knowledge/report-compiler.ts`):
- Import `matter` from `gray-matter`
- Import ResearchReport, QAPair from types
- `compileReport(report: ResearchReport): string`:
  - Generate YAML frontmatter with: sessionId, notebook, taskGoal, queryCount, startTime, endTime, sources array
  - Body: each QAPair as `## Q{N}: {question}` with metadata line (source, relevance, timestamp) and answer text + citations
  - Use `matter.stringify(body, frontmatter)` to produce final markdown
- `ReportCompiler` class:
  - `compile(report: ResearchReport): string` -- delegates to compileReport
  - `getFilePath(sessionId: string, baseDir: string): string` -- returns `{baseDir}/.msw/research/sessions/{sessionId}.md`

**MetadataTracker** (`src/knowledge/metadata.ts`):
- Tracks per-session metadata:
  - `sessionId: string`
  - `notebook: string` (URL)
  - `startTime: Date`
  - `queryCounts: { autoExpansion: number, errorBridge: number, manual: number }`
  - `relevanceScores: number[]` (for computing averages)
- `recordQuery(source: QAPair['source'], relevanceScore?: number): void`
- `getStats(): { totalQueries: number, avgRelevance: number, bySource: Record<string, number> }`
- `toFrontmatter(): Record<string, unknown>` -- returns object suitable for YAML frontmatter
  </action>
  <verify>npx tsc --noEmit src/knowledge/report-compiler.ts src/knowledge/metadata.ts</verify>
  <done>ReportCompiler produces structured markdown with frontmatter; MetadataTracker provides session statistics</done>
</task>

</tasks>

<verification>
- All three files type-check clean
- formatForAgent produces valid markdown
- compileReport produces valid YAML frontmatter + markdown body
- MetadataTracker correctly computes averages
</verification>

<success_criteria>
- Agent context is self-contained readable markdown
- Research reports have proper YAML frontmatter with all metadata fields
- Session statistics accurately reflect query activity
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-communication/03-04-SUMMARY.md`
</output>
