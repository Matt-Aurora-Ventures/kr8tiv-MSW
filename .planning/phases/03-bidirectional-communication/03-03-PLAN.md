---
phase: 03-bidirectional-communication
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/bidirectional/response-parser.ts
  - src/bidirectional/answer-chain.ts
autonomous: true

must_haves:
  truths:
    - "Response parser extracts source citations from NotebookLM answers (best-effort)"
    - "Answer chain aggregates multi-turn Q&A conversations with ordering"
    - "Answer chain summarizes after configurable turn threshold (default 5)"
  artifacts:
    - path: "src/bidirectional/response-parser.ts"
      provides: "Citation extraction from NotebookLM responses"
      exports: ["ResponseParser", "parseCitations"]
    - path: "src/bidirectional/answer-chain.ts"
      provides: "Multi-turn conversation aggregation"
      exports: ["AnswerChain"]
  key_links:
    - from: "src/bidirectional/response-parser.ts"
      to: "src/notebooklm/extractor.ts"
      via: "Extends extraction with citation parsing"
      pattern: "ResponseExtractor|extractLatest"
---

<objective>
Build response parsing with citation extraction and answer chain compilation for multi-turn conversations. This is the output side of the query pipeline.

Purpose: NotebookLM grounds answers in uploaded sources -- capturing those citations provides confidence scoring. Answer chains prevent unbounded context growth.
Output: ResponseParser with citation extraction and AnswerChain with summarization, ready for context injection and report compilation.
</objective>

<execution_context>
@C:\Users\lucid\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\lucid\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-bidirectional-communication/03-RESEARCH.md
@src/notebooklm/extractor.ts
@src/types/bidirectional.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ResponseParser with citation extraction</name>
  <files>src/bidirectional/response-parser.ts</files>
  <action>
Create `src/bidirectional/response-parser.ts`:

- Import Page from Playwright
- Import QAPair from types
- `parseCitations(responseText: string): string[]` (exported standalone function):
  - Best-effort extraction of source citations from NotebookLM response text
  - Pattern 1: Bracketed references like [1], [2], [Source Name]
  - Pattern 2: Superscript-style numbers (if visible in text)
  - Pattern 3: "According to [source]" or "Based on [source]" phrases
  - Return array of citation strings, empty array if none found
  - NEVER throw -- this is best-effort

- `ResponseParser` class:
  - Constructor takes Playwright Page
  - `parseLatestResponse(): Promise<{ text: string, citations: string[] }>`:
    - Get the last assistant message element
    - Extract text content
    - Run parseCitations on the text
    - Return both
  - `parseAllResponses(): Promise<Array<{ text: string, citations: string[] }>>`:
    - Get all assistant message elements
    - Parse each for text + citations

Citation parsing is LOW confidence (per research) -- implement it as robust best-effort with fallback to empty citations array.
  </action>
  <verify>npx tsc --noEmit src/bidirectional/response-parser.ts</verify>
  <done>ResponseParser extracts text and citations from NotebookLM responses without throwing</done>
</task>

<task type="auto">
  <name>Task 2: Implement AnswerChain</name>
  <files>src/bidirectional/answer-chain.ts</files>
  <action>
Create `src/bidirectional/answer-chain.ts`:

- Import QAPair from types
- `AnswerChain` class:
  - Constructor takes `options?: { maxTurnsBeforeSummary?: number }` (default 5)
  - Internal `pairs: QAPair[]` array
  - `add(pair: QAPair): void` -- appends to chain
  - `getAll(): QAPair[]` -- returns all pairs
  - `getLatest(): QAPair | undefined` -- returns most recent
  - `getExistingAnswer(normalizedQuery: string): QAPair | undefined` -- finds pair by question match
  - `needsSummarization(): boolean` -- true if pairs.length >= maxTurnsBeforeSummary
  - `getSummary(): string` -- compiles all pairs into a condensed summary string:
    - Format: "Key findings from {N} research queries:\n" + bullet points of each Q&A
    - Include citations if present
    - This is a text summary, not the full chain
  - `getForContextInjection(): { summary: string, latest: QAPair | undefined }`:
    - If needsSummarization: return summary + latest pair
    - Otherwise: return all pairs formatted as text + latest
  - `clear(): void` -- resets chain
  - `length`: getter for pairs count
  </action>
  <verify>npx tsc --noEmit src/bidirectional/answer-chain.ts</verify>
  <done>AnswerChain aggregates Q&A pairs with summarization to prevent unbounded context growth</done>
</task>

</tasks>

<verification>
- Both files type-check clean
- parseCitations handles empty input, no citations, and various citation formats
- AnswerChain summarizes after threshold
</verification>

<success_criteria>
- Citation parsing is best-effort and never throws
- Answer chain provides bounded context for agent injection
- Both modules ready for wiring in Wave 2
</success_criteria>

<output>
After completion, create `.planning/phases/03-bidirectional-communication/03-03-SUMMARY.md`
</output>
